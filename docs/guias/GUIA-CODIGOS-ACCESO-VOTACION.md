# ğŸ” GuÃ­a: Sistema de CÃ³digos de Acceso para VotaciÃ³n

## ğŸ¯ Â¿CÃ³mo funciona?

### Sistema: **CÃ³digo Ãšnico por Asamblea**

Cada asamblea tiene un cÃ³digo Ãºnico tipo: **`A2K9-X7M4`**

**URL completa:**
```
https://tu-dominio.com/votar/A2K9-X7M4
```

---

## ğŸ“± Flujo Completo (Administrador â†’ Residente)

### 1. **Administrador Crea la Asamblea**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“‹ Nueva Asamblea Creada          â”‚
â”‚  Asamblea Ordinaria 2026            â”‚
â”‚  Fecha: 15 de Febrero 2026         â”‚
â”‚  Estado: ğŸ“ Borrador                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. **Administrador Genera el CÃ³digo**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”“ Activar VotaciÃ³n PÃºblica       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âš ï¸ Esto generarÃ¡ un enlace pÃºblico â”‚
â”‚     para que los residentes voten   â”‚
â”‚                                      â”‚
â”‚  [Cancelar] [Activar VotaciÃ³n]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**El sistema genera automÃ¡ticamente:**
- âœ… CÃ³digo Ãºnico: `A2K9-X7M4`
- âœ… URL: `https://tu-dominio.com/votar/A2K9-X7M4`

### 3. **Panel de Compartir (Para Administrador)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… VotaciÃ³n PÃºblica Activada      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  CÃ³digo de Acceso:                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  A2K9-X7M4                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  [ğŸ“‹ Copiar CÃ³digo]                 â”‚
â”‚                                      â”‚
â”‚  Enlace para Votar:                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ https://tu-dominio.com/votar/ â”‚ â”‚
â”‚  â”‚ A2K9-X7M4                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  [ğŸ“‹ Copiar Enlace]                 â”‚
â”‚  [ğŸ“± Compartir por WhatsApp]       â”‚
â”‚  [ğŸ“§ Enviar por Email]             â”‚
â”‚                                      â”‚
â”‚  [ğŸ”’ Desactivar Acceso PÃºblico]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. **Mensaje de WhatsApp (Ejemplo)**

El administrador puede copiar y pegar:

```
ğŸ“¢ ASAMBLEA ORDINARIA 2026
Conjunto Residencial Las Palmas

ğŸ“… Fecha: 15 de Febrero 2026
ğŸ•’ Hora: 10:00 AM

ğŸ—³ï¸ VOTACIÃ“N DISPONIBLE

Para votar, ingresa a:
ğŸ‘‰ https://tu-dominio.com/votar/A2K9-X7M4

O usa el cÃ³digo: A2K9-X7M4

âš ï¸ Necesitas tu email registrado en el conjunto

Preguntas:
1ï¸âƒ£ AprobaciÃ³n del presupuesto 2026
2ï¸âƒ£ ModificaciÃ³n del reglamento
3ï¸âƒ£ ContrataciÃ³n de vigilancia

Â¡Tu voto es importante! ğŸ 
```

---

## ğŸ—³ï¸ Flujo del Residente (Votante)

### **Paso 1: Acceso**

El residente hace clic en el enlace o va a la pÃ¡gina y ingresa el cÃ³digo:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ—³ï¸  VotaciÃ³n Virtual              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Ingresa el cÃ³digo de tu asamblea:  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ A2K9-X7M4                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  [Continuar]                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Paso 2: ValidaciÃ³n del CÃ³digo**

El sistema valida:
- âœ… CÃ³digo existe
- âœ… Acceso pÃºblico estÃ¡ activo
- âœ… Muestra info de la asamblea

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… CÃ³digo VÃ¡lido                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“‹ Asamblea Ordinaria 2026         â”‚
â”‚  ğŸ¢ Conjunto Residencial Las Palmas â”‚
â”‚  ğŸ“… 15 de Febrero 2026              â”‚
â”‚                                      â”‚
â”‚  Ingresa tu email para continuar:   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ maria@email.com               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  [Continuar]                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Paso 3: ValidaciÃ³n del Votante**

El sistema busca:
1. **Unidades propias**: Â¿El email estÃ¡ en la tabla `unidades`?
2. **Poderes activos**: Â¿Tiene poderes otorgados en esta asamblea?

```sql
-- El sistema ejecuta internamente:
SELECT * FROM validar_votante_asamblea(
  p_codigo_asamblea := 'A2K9-X7M4',
  p_email_votante := 'maria@email.com'
);
```

**Si es vÃ¡lido:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… Bienvenida, MarÃ­a GarcÃ­a        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  EstÃ¡s votando por:                 â”‚
â”‚                                      â”‚
â”‚  ğŸ  Apto 303 - Torre A              â”‚
â”‚     (Tu unidad)                     â”‚
â”‚     Coeficiente: 1.5%               â”‚
â”‚                                      â”‚
â”‚  ğŸ“ Apto 101 - Torre A              â”‚
â”‚     (Poder de Juan PÃ©rez)           â”‚
â”‚     Coeficiente: 2.0%               â”‚
â”‚                                      â”‚
â”‚  ğŸ“ Apto 202 - Torre B              â”‚
â”‚     (Poder de Pedro LÃ³pez)          â”‚
â”‚     Coeficiente: 3.0%               â”‚
â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ TOTAL: 3 unidades           â”‚  â”‚
â”‚  â”‚ Coeficiente: 6.5%           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                      â”‚
â”‚  [Continuar a Votar]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Si NO es vÃ¡lido:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš ï¸ Email No Autorizado             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  El email maria@email.com no estÃ¡   â”‚
â”‚  registrado en este conjunto y no   â”‚
â”‚  tiene poderes activos.             â”‚
â”‚                                      â”‚
â”‚  Contacta al administrador si       â”‚
â”‚  crees que es un error.             â”‚
â”‚                                      â”‚
â”‚  [Intentar con otro email]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Paso 4: Votar**

Ya explicado en `GUIA-SISTEMA-VOTACION-PUBLICA.md`

---

## ğŸ”§ ImplementaciÃ³n TÃ©cnica

### **Funciones SQL Creadas:**

1. **`generar_codigo_acceso()`**
   - Genera cÃ³digo alfanumÃ©rico Ãºnico
   - Formato: `A2K9-X7M4` (sin 0, O, 1, I para evitar confusiÃ³n)

2. **`activar_votacion_publica(asamblea_id, base_url)`**
   - Genera cÃ³digo Ãºnico
   - Crea URL completa
   - Activa `acceso_publico = true`

3. **`desactivar_votacion_publica(asamblea_id)`**
   - Desactiva acceso (sin borrar cÃ³digo)
   - Ãštil para cerrar votaciÃ³n temporalmente

4. **`validar_codigo_acceso(codigo)`**
   - Valida si el cÃ³digo existe
   - Verifica si estÃ¡ activo
   - Retorna info de la asamblea

5. **`validar_votante_asamblea(codigo, email)`**
   - Busca unidades del votante
   - Busca poderes activos
   - Retorna lista completa de unidades que puede representar

---

## ğŸ¨ UI: BotÃ³n en Detalle de Asamblea (Admin)

**En:** `app/dashboard/asambleas/[id]/page.tsx`

```typescript
// Agregar este botÃ³n en el panel de informaciÃ³n de la asamblea:

{!asamblea.acceso_publico ? (
  <Button onClick={handleActivarVotacion}>
    ğŸ”“ Activar VotaciÃ³n PÃºblica
  </Button>
) : (
  <div className="bg-green-50 p-4 rounded">
    <h4>âœ… VotaciÃ³n PÃºblica Activa</h4>
    
    <div className="mt-2">
      <label>CÃ³digo:</label>
      <div className="flex gap-2">
        <input 
          value={asamblea.codigo_acceso} 
          readOnly 
          className="font-mono text-2xl"
        />
        <Button onClick={() => copy(asamblea.codigo_acceso)}>
          ğŸ“‹ Copiar
        </Button>
      </div>
    </div>
    
    <div className="mt-2">
      <label>Enlace:</label>
      <div className="flex gap-2">
        <input 
          value={asamblea.url_publica} 
          readOnly 
        />
        <Button onClick={() => copy(asamblea.url_publica)}>
          ğŸ“‹ Copiar
        </Button>
        <Button onClick={handleCompartirWhatsApp}>
          ğŸ“± WhatsApp
        </Button>
      </div>
    </div>
    
    <Button 
      variant="destructive" 
      onClick={handleDesactivarVotacion}
      className="mt-2"
    >
      ğŸ”’ Desactivar Acceso
    </Button>
  </div>
)}
```

---

## ğŸ” Seguridad

### **Validaciones:**

1. âœ… **CÃ³digo Ãºnico por asamblea**
2. âœ… **Solo funciona si `acceso_publico = true`**
3. âœ… **Email debe existir en `unidades` o en `poderes`**
4. âœ… **Cada unidad solo puede votar una vez**
5. âœ… **Trazabilidad completa en `historial_votos`**

### **ProtecciÃ³n contra abusos:**

- CÃ³digo se puede desactivar en cualquier momento
- Registro de IP y User-Agent
- Solo emails registrados pueden votar
- No se puede votar dos veces por la misma unidad

---

## ğŸ“Š Ejemplo de Uso Real

### **Escenario:**

**Conjunto "Las Palmas" con 50 unidades**

1. Admin crea asamblea â†’ Estado: Borrador
2. Admin agrega 3 preguntas
3. Admin abre las preguntas â†’ Estado: Abiertas
4. Admin activa votaciÃ³n pÃºblica â†’ CÃ³digo: `M3P7-R9K2`
5. Admin comparte enlace por WhatsApp
6. **MarÃ­a** (Apto 303) vota por sus 3 unidades (1 propia + 2 poderes)
7. **Juan** (Apto 101) vota por su unidad
8. **Pedro** intenta votar pero ya MarÃ­a votÃ³ por su unidad (poder) â†’ âœ… Sistema lo permite porque Pedro tiene su propia unidad
9. Sistema calcula quÃ³rum en tiempo real
10. Admin cierra preguntas cuando termine
11. Admin desactiva acceso pÃºblico
12. Admin exporta reporte a PDF

---

## ğŸš€ PrÃ³ximos Pasos

1. âœ… **Ejecutar SQL**: `AGREGAR-CODIGO-ACCESO-ASAMBLEAS.sql`
2. â³ **Actualizar interfaz admin**: Agregar botÃ³n "Activar VotaciÃ³n"
3. â³ **Crear pÃ¡gina pÃºblica**: `/votar/[codigo]`
4. â³ **Implementar validaciÃ³n de acceso**
5. â³ **Testing completo**

---

**Â¿Quieres que implemente ahora la interfaz de administrador con los botones para generar y compartir el cÃ³digo?** ğŸš€
